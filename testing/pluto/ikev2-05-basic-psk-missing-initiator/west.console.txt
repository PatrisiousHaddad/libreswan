/testing/guestbin/swan-prep
west #
 # confirm that the network is alive
west #
 ../../guestbin/wait-until-alive -I 192.0.1.254 192.0.2.254
destination -I 192.0.1.254 192.0.2.254 is alive
west #
 # ensure that clear text does not get through
west #
 iptables -A INPUT -i eth1 -s 192.0.2.0/24 -j DROP
west #
 iptables -I INPUT -m policy --dir in --pol ipsec -j ACCEPT
west #
 # confirm clear text does not get through
west #
 ../../guestbin/ping-once.sh --down -I 192.0.1.254 192.0.2.254
down
west #
 ipsec start
Redirecting to: [initsystem]
west #
 ../../guestbin/wait-until-pluto-started
west #
 ipsec auto --add westnet-eastnet-ipv4-psk-ikev2
"westnet-eastnet-ipv4-psk-ikev2": added IKEv2 connection
west #
 ipsec whack --impair suppress_retransmits
west #
 echo "initdone"
initdone
west #
 ipsec auto --up westnet-eastnet-ipv4-psk-ikev2
"westnet-eastnet-ipv4-psk-ikev2" #1: initiating IKEv2 connection to 192.1.2.23 using UDP
"westnet-eastnet-ipv4-psk-ikev2" #1: sent IKE_SA_INIT request to 192.1.2.23:UDP/500
"westnet-eastnet-ipv4-psk-ikev2" #1: authentication failed: no PSK found for '@west'
EXPECTATION FAILED: "westnet-eastnet-ipv4-psk-ikev2" #1: state transition function for STATE_V2_PARENT_I1 had internal error (complete_v2_state_transition() +2735 programs/pluto/ikev2.c)
west #
 ../../guestbin/ping-once.sh --up -I 192.0.1.254 192.0.2.254
down UNEXPECTED
# ping -n -c 1  -i 6 -w 5   -I 192.0.1.254 192.0.2.254
PING 192.0.2.254 (192.0.2.254) from 192.0.1.254 : 56(84) bytes of data. --- 192.0.2.254 ping statistics --- 1 packets transmitted, 0 received, 100% packet loss, time XXXX
west #
 ipsec whack --trafficstatus
west #
 echo done
done
west #
 ../../guestbin/ipsec-kernel-state.sh
west #
 ../../guestbin/ipsec-kernel-policy.sh
west #
 >>>>>>>>>> post-mortem >>>>>>>>>>../../guestbin/post-mortem.sh
   PPID     PID    PGID     SID TTY        TPGID STAT   UID   TIME COMMAND
:
: checking shutting down pluto
:
ipsec whack --shutdown
ERROR: ipsec whack: connect(pluto_ctl) failed: Connection refused (errno 111)
FAIL: shutting down pluto
:
: checking core files
:
CORE FOUND: /tmp/core.west.pluto.677
Reading symbols from PATH/libexec/ipsec/pluto...
[New LWP 677]
[New LWP 679]
Missing separate debuginfo for /lib64/libpam.so.0.
The debuginfo package for this file is probably broken.
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib64/libthread_db.so.1".
Core was generated by `PATH/libexec/ipsec/pluto --leak-detective --config /etc/ipsec.conf --nofo'.
Program terminated with signal SIGABRT, Aborted.
#0  __pthread_kill_implementation (threadid=<optimized out>, 
    signo=signo@entry=6, no_tid=no_tid@entry=0) at pthread_kill.c:44
44      return INTERNAL_SYSCALL_ERROR_P (ret) ? INTERNAL_SYSCALL_ERRNO (ret) : 0;
[Current thread is 1 (Thread 0x7fc03728c980 (LWP 677))]
Missing separate debuginfos, use: dnf debuginfo-install krb5-libs-1.21.2-1.fc39.x86_64 libcap-2.48-7.fc39.x86_64 libeconf-0.5.2-1.fc39.x86_64 libnghttp2-1.55.1-2.fc39.x86_64 libstdc++-13.2.1-3.fc39.x86_64 libzstd-1.5.5-4.fc39.x86_64 protobuf-c-1.4.1-5.fc39.x86_64 python3-libs-3.12.0-1.fc39.x86_64 softhsm-2.6.1-5.fc39.7.x86_64
CRASHING THREAD:
#0  __pthread_kill_implementation (threadid=<optimized out>, signo=signo@entry=6, no_tid=no_tid@entry=0) at pthread_kill.c:44
#1  0x00007fc037e348a3 in __pthread_kill_internal (signo=6, threadid=<optimized out>) at pthread_kill.c:78
#2  0x00007fc037de28ee in __GI_raise (sig=sig@entry=6) at ../sysdeps/posix/raise.c:26
#3  0x00007fc037dca8ff in __GI_abort () at abort.c:79
#4  0x0000564cb72b28e2 in logjam_to_logger (logjam=logjam@entry=0x7ffe07a60660) at /source/lib/libswan/logjam.c:51
#5  0x0000564cb738a829 in passert_logjam_to_logger (logjam=logjam@entry=0x7ffe07a60660) at /source/lib/libswan/passert.c:37
#6  0x0000564cb738a908 in llog_passert (logger=<optimized out>, where=where@entry=0x564cb7464ef0 <here>, fmt=fmt@entry=0x564cb73f9a92 "%s") at /source/lib/libswan/passert.c:32
#7  0x0000564cb7366459 in ikev2_process_sa_payload (what=what@entry=0x564cb73c1ea0 "IKE initiator (accepting)", sa_payload=sa_payload@entry=0x7fc0331dc9b8, expect_ike=expect_ike@entry=true, expect_spi=expect_spi@entry=false, expect_accepted=expect_accepted@entry=true, opportunistic=false, chosen_proposal=0x7fc0331d88d8, local_proposals=0x7fc03310ffe8, logger=0x7fc0331dafc8) at /source/programs/pluto/ikev2_proposals.c:1144
#8  0x0000564cb72ba3dc in process_v2_IKE_SA_INIT_response (ike=0x7fc0331d8348, unused_child=<optimized out>, md=0x7fc0331dc6f8) at /source/programs/pluto/ikev2_ike_sa_init.c:1472
#9  0x0000564cb735e149 in v2_dispatch (ike=ike@entry=0x7fc0331d8348, md=md@entry=0x7fc0331dc6f8, svm=svm@entry=0x564cb7481d60 <v2_state_transition_table+448>) at /source/programs/pluto/ikev2.c:2341
#10 0x0000564cb72b8834 in process_v2_IKE_SA_INIT (md=md@entry=0x7fc0331dc6f8) at /source/programs/pluto/ikev2_ike_sa_init.c:495
#11 0x0000564cb735e878 in ikev2_process_packet (md=md@entry=0x7fc0331dc6f8) at /source/programs/pluto/ikev2.c:1854
#12 0x0000564cb736cf5d in process_md (md=0x7fc0331dc6f8) at /source/programs/pluto/demux.c:189
#13 0x0000564cb736d27a in process_iface_packet (fd=<optimized out>, ifp_arg=0x0, logger=<optimized out>) at /source/programs/pluto/demux.c:294
#14 0x0000564cb73339a2 in fd_read_listener_event_handler (fd=<optimized out>, events=<optimized out>, arg=<optimized out>) at /source/programs/pluto/server.c:792
#15 0x00007fc037faefec in event_persist_closure (ev=<optimized out>, base=<optimized out>) at PATH/src/debug/libevent-2.1.12-9.fc39.x86_64/event.c:1623
#16 event_process_active_single_queue (base=base@entry=0x7fc033c9fd68, activeq=0x7fc033ca5fe8, max_to_process=max_to_process@entry=2147483647, endtime=endtime@entry=0x0) at PATH/src/debug/libevent-2.1.12-9.fc39.x86_64/event.c:1682
#17 0x00007fc037fb0ccf in event_process_active (base=0x7fc033c9fd68) at PATH/src/debug/libevent-2.1.12-9.fc39.x86_64/event.c:1783
#18 event_base_loop (base=0x7fc033c9fd68, flags=flags@entry=0) at PATH/src/debug/libevent-2.1.12-9.fc39.x86_64/event.c:2006
#19 0x0000564cb733633e in run_server (conffile=0x7fc036892fe8 "/etc/ipsec.conf", logger=0x7ffe07a61ca0) at /source/programs/pluto/server.c:1067
#20 0x0000564cb72b4e68 in main (argc=<optimized out>, argv=<optimized out>) at /source/programs/pluto/plutomain.c:1808
INSTRUCTION:
=> 0x7fc037e34834 <__pthread_kill_implementation+276>:mov    %eax,%ebx
SOURCE CODE:
39         delivery of all pending signals after unblocking in the code
40         below.  POSIX only guarantees delivery of a single signal,
41         which may not be the right one.)  */
42      pid_t tid = INTERNAL_SYSCALL_CALL (gettid);
43      int ret = INTERNAL_SYSCALL_CALL (tgkill, __getpid (), tid, signo);
44      return INTERNAL_SYSCALL_ERROR_P (ret) ? INTERNAL_SYSCALL_ERRNO (ret) : 0;
45    }
46
47  /* Block all signals, as required by pd->exit_lock.  */
48  internal_sigset_t old_mask;
LOCAL VARIABLES:
tid = <optimized out>
ret = 0
pd = <optimized out>
old_mask = {__val = {0}}
ret = <optimized out>
FUNCTION ARGUMENTS:
threadid = <optimized out>
signo = 6
no_tid = 0
LOCAL SCOPE:
requires an argument (function, line or *addr) to define a scope
FRAME:
Stack level 0, frame at 0x7ffe07a60510:
 rip = 0x7fc037e34834 in __pthread_kill_implementation (pthread_kill.c:44); saved rip = 0x7fc037e348a3
 called by frame at 0x7ffe07a60510
 source language c.
 Arglist at 0x7ffe07a60500, args: threadid=<optimized out>, signo=signo@entry=6, no_tid=no_tid@entry=0
 Locals at 0x7ffe07a60500, Previous frame's sp is 0x7ffe07a60510
 Saved registers:
  rbx at 0x7ffe07a604d8, rbp at 0x7ffe07a60500, r12 at 0x7ffe07a604e0, r13 at 0x7ffe07a604e8, r14 at 0x7ffe07a604f0, r15 at 0x7ffe07a604f8
REGISTERS:
rax            0x0                 0
rbx            0x2a5               677
rcx            0x7fc037e34834      140463548090420
rdx            0x6                 6
rsi            0x2a5               677
rdi            0x2a5               677
rbp            0x7ffe07a60500      0x7ffe07a60500
rsp            0x7ffe07a604c0      0x7ffe07a604c0
r8             0x0                 0
r9             0x1                 1
r10            0x8                 8
r11            0x246               582
r12            0x7fc03728c980      140463535868288
r13            0x7fc0331d88d8      140463468021976
r14            0x6                 6
r15            0x1                 1
rip            0x7fc037e34834      0x7fc037e34834 <__pthread_kill_implementation+276>
eflags         0x246               [ PF ZF IF ]
cs             0x33                51
ss             0x2b                43
ds             0x0                 0
es             0x0                 0
fs             0x0                 0
gs             0x0                 0
ALL THREADS:
Thread 2 (Thread 0x7fc033aff6c0 (LWP 679)):
#0  0x00007fc037e2f169 in __futex_abstimed_wait_common64 (private=0, cancel=true, abstime=0x0, op=393, expected=0, futex_word=0x564cb74b3ae8 <backlog_cond+40>) at futex-internal.c:57
#1  __futex_abstimed_wait_common (futex_word=futex_word@entry=0x564cb74b3ae8 <backlog_cond+40>, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, private=private@entry=0, cancel=cancel@entry=true) at futex-internal.c:87
#2  0x00007fc037e2f1ef in __GI___futex_abstimed_wait_cancelable64 (futex_word=futex_word@entry=0x564cb74b3ae8 <backlog_cond+40>, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, private=private@entry=0) at futex-internal.c:139
#3  0x00007fc037e31b09 in __pthread_cond_wait_common (abstime=0x0, clockid=0, mutex=0x564cb74b3ac0 <backlog_cond>, cond=0x564cb74b3ac0 <backlog_cond>) at pthread_cond_wait.c:503
#4  ___pthread_cond_wait (cond=cond@entry=0x564cb74b3ac0 <backlog_cond>, mutex=mutex@entry=0x564cb74b3b00 <backlog_mutex>) at pthread_cond_wait.c:618
#5  0x0000564cb7337c6b in helper_thread (arg=0x7fc033c2efe8) at /source/programs/pluto/server_pool.c:233
#6  0x00007fc037e32897 in start_thread (arg=<optimized out>) at pthread_create.c:444
#7  0x00007fc037eb96bc in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:78
Thread 1 (Thread 0x7fc03728c980 (LWP 677)):
#0  __pthread_kill_implementation (threadid=<optimized out>, signo=signo@entry=6, no_tid=no_tid@entry=0) at pthread_kill.c:44
#1  0x00007fc037e348a3 in __pthread_kill_internal (signo=6, threadid=<optimized out>) at pthread_kill.c:78
#2  0x00007fc037de28ee in __GI_raise (sig=sig@entry=6) at ../sysdeps/posix/raise.c:26
#3  0x00007fc037dca8ff in __GI_abort () at abort.c:79
#4  0x0000564cb72b28e2 in logjam_to_logger (logjam=logjam@entry=0x7ffe07a60660) at /source/lib/libswan/logjam.c:51
#5  0x0000564cb738a829 in passert_logjam_to_logger (logjam=logjam@entry=0x7ffe07a60660) at /source/lib/libswan/passert.c:37
#6  0x0000564cb738a908 in llog_passert (logger=<optimized out>, where=where@entry=0x564cb7464ef0 <here>, fmt=fmt@entry=0x564cb73f9a92 "%s") at /source/lib/libswan/passert.c:32
#7  0x0000564cb7366459 in ikev2_process_sa_payload (what=what@entry=0x564cb73c1ea0 "IKE initiator (accepting)", sa_payload=sa_payload@entry=0x7fc0331dc9b8, expect_ike=expect_ike@entry=true, expect_spi=expect_spi@entry=false, expect_accepted=expect_accepted@entry=true, opportunistic=false, chosen_proposal=0x7fc0331d88d8, local_proposals=0x7fc03310ffe8, logger=0x7fc0331dafc8) at /source/programs/pluto/ikev2_proposals.c:1144
#8  0x0000564cb72ba3dc in process_v2_IKE_SA_INIT_response (ike=0x7fc0331d8348, unused_child=<optimized out>, md=0x7fc0331dc6f8) at /source/programs/pluto/ikev2_ike_sa_init.c:1472
#9  0x0000564cb735e149 in v2_dispatch (ike=ike@entry=0x7fc0331d8348, md=md@entry=0x7fc0331dc6f8, svm=svm@entry=0x564cb7481d60 <v2_state_transition_table+448>) at /source/programs/pluto/ikev2.c:2341
#10 0x0000564cb72b8834 in process_v2_IKE_SA_INIT (md=md@entry=0x7fc0331dc6f8) at /source/programs/pluto/ikev2_ike_sa_init.c:495
#11 0x0000564cb735e878 in ikev2_process_packet (md=md@entry=0x7fc0331dc6f8) at /source/programs/pluto/ikev2.c:1854
#12 0x0000564cb736cf5d in process_md (md=0x7fc0331dc6f8) at /source/programs/pluto/demux.c:189
#13 0x0000564cb736d27a in process_iface_packet (fd=<optimized out>, ifp_arg=0x0, logger=<optimized out>) at /source/programs/pluto/demux.c:294
#14 0x0000564cb73339a2 in fd_read_listener_event_handler (fd=<optimized out>, events=<optimized out>, arg=<optimized out>) at /source/programs/pluto/server.c:792
#15 0x00007fc037faefec in event_persist_closure (ev=<optimized out>, base=<optimized out>) at PATH/src/debug/libevent-2.1.12-9.fc39.x86_64/event.c:1623
#16 event_process_active_single_queue (base=base@entry=0x7fc033c9fd68, activeq=0x7fc033ca5fe8, max_to_process=max_to_process@entry=2147483647, endtime=endtime@entry=0x0) at PATH/src/debug/libevent-2.1.12-9.fc39.x86_64/event.c:1682
#17 0x00007fc037fb0ccf in event_process_active (base=0x7fc033c9fd68) at PATH/src/debug/libevent-2.1.12-9.fc39.x86_64/event.c:1783
#18 event_base_loop (base=0x7fc033c9fd68, flags=flags@entry=0) at PATH/src/debug/libevent-2.1.12-9.fc39.x86_64/event.c:2006
#19 0x0000564cb733633e in run_server (conffile=0x7fc036892fe8 "/etc/ipsec.conf", logger=0x7ffe07a61ca0) at /source/programs/pluto/server.c:1067
#20 0x0000564cb72b4e68 in main (argc=<optimized out>, argv=<optimized out>) at /source/programs/pluto/plutomain.c:1808
FAIL: core files
:
: checking memory leaks
:
SKIP: memory leaks as pluto was not running
:
: checking reference leaks
:
SKIP: reference leaks as pluto was not running
:
: checking xfrm errors
:
SKIP: xfrm errors as pluto was not running
:
: checking state entries
:
SKIP: state entries as pluto was not running
:
: checking policy entries
:
SKIP: policy entries as pluto was not running
:
: checking selinux audit records
:
type=AVC msg=audit(1707965260.816:134): avc:  denied  { write } for  pid=717 comm="tee" name="/" dev="tmpfs" ino=1 scontext=system_u:system_r:kernel_generic_helper_t:s0 tcontext=system_u:object_r:tmp_t:s0 tclass=dir permissive=1
type=AVC msg=audit(1707965260.816:135): avc:  denied  { add_name } for  pid=717 comm="tee" name="core.west.pluto.677" scontext=system_u:system_r:kernel_generic_helper_t:s0 tcontext=system_u:object_r:tmp_t:s0 tclass=dir permissive=1
type=AVC msg=audit(1707965260.816:136): avc:  denied  { create } for  pid=717 comm="tee" name="core.west.pluto.677" scontext=system_u:system_r:kernel_generic_helper_t:s0 tcontext=system_u:object_r:tmp_t:s0 tclass=file permissive=1
type=AVC msg=audit(1707965260.816:137): avc:  denied  { write open } for  pid=717 comm="tee" path="/tmp/core.west.pluto.677" dev="tmpfs" ino=23 scontext=system_u:system_r:kernel_generic_helper_t:s0 tcontext=system_u:object_r:tmp_t:s0 tclass=file permissive=1
FAIL: selinux audit records
saving rules in OUTPUT/west.post-mortem.audit2allow.rules
require {
	type kernel_generic_helper_t;
}
#============= kernel_generic_helper_t ==============
files_manage_generic_tmp_files(kernel_generic_helper_t)
insights_client_filetrans_tmp(kernel_generic_helper_t)
:
: unload any selinux modules
:
west #
 
